package com.example.testruby;

import android.os.Bundle;
import android.app.Activity;
import android.view.Menu;

import android.content.res.AssetManager;

import java.io.ByteArrayOutputStream;   
import java.io.IOException;   
import java.io.InputStream;
import java.io.OutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.util.*;

import com.srplab.www.starcore.*;

public class MainActivity extends Activity {

	public static MainActivity Host;
	public StarSrvGroupClass SrvGroup;
	
	private static boolean CreatePath(String Path){
		File destCardDir = new File(Path);
        if(!destCardDir.exists()){
        	int Index = Path.lastIndexOf(File.separator.charAt(0));
        	if( Index < 0 ){
        		if( destCardDir.mkdirs() == false )
        			return false;
        	}else{
        		String ParentPath = Path.substring(0, Index);
        		if( CreatePath(ParentPath) == false )
        			return false;
        		if( destCardDir.mkdirs() == false )
        			return false;        		
        	}
        }
        return true;
    }    
    private static boolean unzip(InputStream zipFileName, String outputDirectory,Boolean OverWriteFlag ) {
        try {
            ZipInputStream in = new ZipInputStream(zipFileName);
            ZipEntry entry = in.getNextEntry();
            byte[] buffer = new byte[1024];
            while (entry != null) {
                File file = new File(outputDirectory);
                file.mkdir();
                if (entry.isDirectory()) {
                    String name = entry.getName();
                    name = name.substring(0, name.length() - 1);
                    if( CreatePath(outputDirectory + File.separator + name) == false )
                    	return false;
                } else {
                	String name = outputDirectory + File.separator + entry.getName();
                	int Index = name.lastIndexOf(File.separator.charAt(0));
                	if( Index < 0 ){
                		file = new File(outputDirectory + File.separator + entry.getName());
                	}else{
                		String ParentPath = name.substring(0, Index);
                		if( CreatePath(ParentPath) == false )
                			return false;             
                		file = new File(outputDirectory + File.separator + entry.getName());
                	}
                    if( !file.exists() || OverWriteFlag == true){
                    	file.createNewFile();
                    	FileOutputStream out = new FileOutputStream(file);
                    	int readLen = 0;  
        	            while((readLen = in.read(buffer)) != -1){  
        	                out.write(buffer, 0, readLen);  
        	            }                      	
                    	out.close();
                    }
                }
                entry = in.getNextEntry();
            }
            in.close();
            return true;
        } catch (FileNotFoundException e) {
            e.printStackTrace();
            return false;
        } catch (IOException e) {
            e.printStackTrace();
            return false;
        }
    }
	
	private void copyFile(Activity c, String Name,String desPath) throws IOException {  
		File outfile = null;
		if( desPath != null )
			outfile = new File("/data/data/"+getPackageName()+"/files/"+desPath+Name);
		else
			outfile = new File("/data/data/"+getPackageName()+"/files/"+Name); 
	    //if (!outfile.exists()) {
	    	outfile.createNewFile();
        	FileOutputStream out = new FileOutputStream(outfile);        	
	        byte[] buffer = new byte[1024];  
	        InputStream in;  
	        int readLen = 0;  
	        if( desPath != null )
	        	in = c.getAssets().open(desPath+Name);
	        else
	        	in = c.getAssets().open(Name);
            while((readLen = in.read(buffer)) != -1){  
                out.write(buffer, 0, readLen);  
            }  
            out.flush();  
            in.close();  
	        out.close();  
	    //}  
	}
	
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        
        Host = this;
        
        File destDir = new File("/data/data/"+getPackageName()+"/files");
        if(!destDir.exists())
        	destDir.mkdirs();
        try{    	
        	copyFile(this,"testrb.rb",null);
        	copyFile(this,"cmath.rb",null);
        }
        catch(Exception e){
        	System.out.println(e);        	
        }          
        
		try{
			System.load("/data/data/"+getPackageName()+"/lib/libruby.so");
		}
		catch(UnsatisfiedLinkError ex)
		{
			System.out.println(ex.toString());
		}    

        /*----init starcore----*/
        StarCoreFactoryPath.StarCoreCoreLibraryPath = "/data/data/"+getPackageName()+"/lib";
        StarCoreFactoryPath.StarCoreShareLibraryPath = "/data/data/"+getPackageName()+"/lib";
        StarCoreFactoryPath.StarCoreOperationPath = "/data/data/"+getPackageName()+"/files";
        
		StarCoreFactory starcore= StarCoreFactory.GetFactory();
		StarServiceClass Service=starcore._InitSimple("test","123",0,0);
		StarSrvGroupClass SrvGroup = (StarSrvGroupClass)Service._Get("_ServiceGroup");
		Service._CheckPassword(false);
		
		SrvGroup._InitRaw("ruby",Service);
		StarObjectClass ruby = Service._ImportRawContext("ruby","",false,"");
		System.out.println(ruby._Get("LOAD_PATH"));
		System.out.println(ruby._Get("File"));
/*		
		StarParaPkgClass para = (StarParaPkgClass)ruby._Get("LOAD_PATH");
		
		for (Object obj : para )
            System.out.println(obj);
*/            
		StarObjectClass LOAD_PATH = (StarObjectClass)ruby._R("LOAD_PATH");
		System.out.println(LOAD_PATH);
		LOAD_PATH._Call("unshift", "/data/data/"+getPackageName()+"/files");
		
		StarObjectClass para = (StarObjectClass)ruby._Get("LOAD_PATH");
		
		for (Object obj : para )
            System.out.println(obj);
		
		ruby._Call("require","cmath");
		System.out.println(ruby._Get("CMath"));
		
		//--load ruby module ---*/
		SrvGroup._LoadRawModule("ruby","","/data/data/"+getPackageName()+"/files/testrb.rb",false);
		//--attach object to global ruby space ---*/
		StarObjectClass object = Service._ImportRawContext("ruby","",false,"");  
		//--call ruby function tt, the return contains two integer, which will be packed into parapkg ---*/
		StarObjectClass RetObj = (StarObjectClass)object._Call("tt","hello ","world");
		System.out.println("ret from ruby : "+RetObj._Get(0)+"  "+RetObj._Get(1));
		//--get global int value g1--------*/
		System.out.println("ruby value g1 :  "+object._Get("g1"));
		//--get global class Multiply
        StarObjectClass Multiply = Service._ImportRawContext("ruby","Multiply",true,"");
        StarObjectClass multiply = Multiply._New("","",33,44);
        //--call instance method multiply
        System.out.println("instance multiply = "+multiply._Call("multiply",11,22));	
        
        String CorePath = "/data/data/"+getPackageName()+"/files";
        ruby._Set("$JavaClass", CallBackClass.class);
        Service._DoFile("ruby", CorePath + "/test_calljava.rb", "");  //should not use null
		
    }


    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        // Inflate the menu; this adds items to the action bar if it is present.
        getMenuInflater().inflate(R.menu.main, menu);
        return true;
    }
    
}
